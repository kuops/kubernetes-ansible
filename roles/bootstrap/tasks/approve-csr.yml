---
- name: 查询是否有 bootstrap rolebinding
  shell: |
    /usr/local/bin/kubectl get clusterrolebinding|grep 'bootstrap'
  register: role_result
  delegate_to: "{{ groups['master'][0] }}"
  run_once: true
  ignore_errors: True

- name: 允许 node 节点加入集群
  shell: |
    /usr/local/bin/kubectl create clusterrolebinding kubeadm:kubelet-bootstrap \
        --clusterrole system:node-bootstrapper --group system:bootstrappers
  when: role_result is failed
  delegate_to: "{{ groups['master'][0] }}"
  run_once: true

- name: 复制 approve-csr yaml 文件
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items:
    - { src: 'approve-csr-clusterrole.yaml', dest: '/root/approve-csr-clusterrole.yaml' }
    - { src: 'approve-csr-clusterrolebinding.yaml', dest: '/root/approve-csr-clusterrolebinding.yaml' }
  delegate_to: "{{ groups['master'][0] }}"
  run_once: true
  notify:
    - apply clusterrole
